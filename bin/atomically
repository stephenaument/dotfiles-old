#!/bin/bash

if [ -n "$(git status --porcelain)" ]; then
  echo "ERROR: You have a dirty working copy. This command would remove any files not already checked in"
  exit 1
fi

log() {
  if [ $VERBOSE ]; then echo $@; fi
}

b="$(git symbolic-ref HEAD 2>/dev/null)"
branch="`basename $b`"
range="origin/${branch-master}..${branch-master}"

while [ $# -gt 0 ]; do
  case "$1" in
    -r|--range) range=$2; shift ;;
    -v|--verbose) VERBOSE=1 ;;
    (--) shift; break ;;
    (*) break ;;
  esac
  shift
done

program=$@

log "Range: $range"
log "Program: $program"

git rev-list $range | while read rev; do
  trap "exit 1" SIGINT SIGTERM
  echo
  echo "Running at revision $rev"
  echo
  git checkout $rev --quiet && git clean -fd && $program || exit 1
  echo
  trap - SIGINT SIGTERM
done

git checkout $branch --quiet
